@inject UserManager<Usuario> UserManager
@{
    var _usuario = (UserManager.GetUserAsync(User)).Result;
    bool _isAdmin = UserManager.IsInRoleAsync(_usuario, Constants.Claims.ES_ADMINISTRADOR).Result;
}
    <meta meta charset=utf-8>
<div ng-app="adminCertificadosApp">
    <div ng-controller="adminCertificadosController">
        <h2>{{title}}</h2>
        <hr />

        <form name="certificadoForm">
            @if (_isAdmin)
            {
                <div ng-show="viewResul"  ng-bind-html="trustedHtml" ng-class="{'alert alert-success' : cargaOk, 'alert alert-danger' : cargaNOk }"></div>
                <div class="card">
                    <div class="card-header">Cargar notas</div>
                    <div class="card-body">
                        <div class="container">
                            <div class="form-group">
                                <label>Certificados</label>
                                <select class="custom-select" name="certificados" id="certificados"
                                        ng-model="certificadosSelected"
                                        ng-options="item.id as item.nombre  for item in certificados">
                                    <option value="">--Seleccione el tipo de certificado--</option>
                                </select>
                            </div>
                            <div class="row">
                                <input ng-disabled="certificadosSelected==null" type="file" name="file" />
                            </div>
                            <br />
                            <div class="row">
                                <button ng-disabled="certificadosSelected==null||cargarDisabled" class="btn btn-primary"  ng-click="cargar()">{{cargarText}}</button>
                            </div>
                        </div>
                    </div>

                </div>
            }

            <br />
            <div class="card">

                <div class="card-header row mx-0">
                    <div>
                        <p class="ml-2">Certificados</p>
                    </div>
                    <div class="ml-auto">
                        <button class="btn btn-outline-success"
                                ng-click="dowloadZip()"
                                ng-disabled="zipLoading">
                            {{zipText}}
                        </button>
                    </div>
                    <div class="ml-1">
                        <button class="btn btn-success"
                                ng-click="exportData()"
                                ng-disabled="exportLoading">
                            {{exportText}}
                        </button>
                    </div>
                    <div class="ml-1">
                        <button class="btn btn-primary " ng-click="showFliters()">Mostrar Filtros</button>
                    </div>

                </div>
                <div ng-show="showProgress">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar"
                             aria-valuenow="75"
                             aria-valuemin="0"
                             aria-valuemax="100"
                             ng-style="{'width':progressStyle}">
                        </div>
                    </div>
                    <p class="ml-2">
                        Procesando {{someThing}} de {{countNotas}}
                    </p>
                   
                </div>


                <div class="card-body no-padding">
                    <div class="container no-padding">
                        <font size="2">
                            <table class="table table-bordered ">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Correo</th>
                                        <th>Tipo de Certificado</th>
                                        <th>Duración</th>
                                        <th>Fecha de entrega</th>
                                        <th>Nota</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" ng-show="loadingTable">Cargando datos....</td>
                                    </tr>
                                    <tr>
                                        <td colspan="7" ng-show="!loadingTable&&notas.length==0">No hay datos para mostrar</td>
                                    </tr>
                                    <tr ng-repeat="nota in notas" ng-show="!loadingTable">
                                        <td>{{nota.nombreUsuario}}</td>
                                        <td>{{nota.email}}</td>
                                        <td>{{nota.nombreCertificado}}</td>
                                        <td>{{nota.duracion}} Horas</td>
                                        <td>{{nota.fechaEntrega | date:'dd-MM-yyyy'}}</td>
                                        <td>{{nota.notaFinal | number:2}}</td>
                                        <td>
                                            <button class="btn btn-success"
                                                    ng-click="downloadPdf(
                                                    nota.nombreUsuario,
                                                    nota.notaFinal | number:1,
                                                    nota.fechaEntrega | date:'d',
                                                    nota.fechaEntrega | date:'MMMM',
                                                    nota.fechaEntrega | date:'yyyy',
                                                    nota.numeroSerie,
                                                    nota.codigo
                                                )">
                                                Descargar
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="ml-2" ng-show="!loadingTable&&notas.length>0">
                                <nav aria-label="Paginación">
                                    <ul class="pagination">
                                        <li class="page-item"><a class="page-link" ng-click="prevPage()" ng-hide="pageIndex == startPageIndex">Anterior</a></li>
                                        <li ng-repeat="x in [].constructor(stopPageIndex-startPageIndex+1) track by $index"
                                            class="page-item"
                                            ng-class="{'page-item active' : pageIndex==$index+startPageIndex}">
                                            <a class="page-link" ng-click="goToPage($index+startPageIndex)">{{ $index+startPageIndex }}</a>
                                        </li>
                                        <li class="page-item"><a class="page-link" ng-click="nextPage()" ng-hide="pageIndex == stopPageIndex">Siguiente</a></li>
                                    </ul>
                                </nav>
                            </div>

                        </font>

                    </div>
                </div>
            </div>
            <hr />
            <div class="modal fade" id="modalFiltros" tabindex="-1" role="dialog" aria-labelledby="modalFiltros" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"> Filtrar por:</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="container">
                                <div class="form-group">
                                    <label>Nombre/Apellido</label>
                                    <input type="text" class="form-control" ng-model="filtroNombre" />
                                </div>
                                <div class="form-group">
                                    <label>Correo</label>
                                    <input type="text" class="form-control" ng-model="filtroCorreo" />
                                </div>
                                <div class="form-group">
                                    <label>Ministerio</label>
                                    <select class="custom-select"
                                            ng-model="filtroMinisterio"
                                            ng-options="item.id as item.nombre  for item in ministeriosList"
                                            ng-change="changeMinisterio()">
                                        <option value="">--Seleccione el Ministerio--</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Servicio</label>
                                    <select class="custom-select"
                                            ng-model="filtroServicio"
                                            ng-options="item.id as item.nombre  for item in filteredServicios" ng-disabled="disableServicios">
                                        <option value="">--Seleccione el Servicio--</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-primary" ng-click="filtrar()">Filtrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="modalZip" tabindex="-1" role="dialog" aria-labelledby="modalZip" aria-hidden="true" data-backdrop="static">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"> Descargar archivos</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="container">
                                <h4>Se descargaran {{countNotas}} certificados, esta acción puede tardar varios minutos, ¿desea continuar?</h4>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" ng-click="cancelDownload()">No</button>
                                <button type="button" class="btn btn-primary" ng-click="processZip()">Si</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    </div>
</div>

